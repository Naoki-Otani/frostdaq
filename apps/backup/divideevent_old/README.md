# extract_events

This tool extracts a specified range of events from a RAYRAW  `.dat` binary file  
and saves them into a new `.dat` file.  
It also **detects the maximum event number** in the input file and **warns** if the specified `end_event` is larger.

---

## 1. Build

Compile with `g++`:

### Linux / macOS
```bash
g++ -O2 -std=c++17 extract_events.cpp -o extract_events
```

### Windows (MinGW)
```bash
g++ -O2 -std=c++17 extract_events.cpp -o extract_events.exe
```

---

## 2. Usage

```bash
./extract_events <input.dat> <output_directory> <start_event> <end_event>
```

### Example

```bash
./extract_events /hoge/input/run00001.dat /hoge/output 10000 20000
```

- Extracts **events 10000 to 20000** from `run00001.dat`
- Output file is automatically named:

```
/hoge/output/run00001_10000_20000.dat
```

After extraction, the program prints:

```
Output file: /hoge/output/run00001_10000_20000.dat
Extraction complete.
Max event number in file: <max_event_num>
Warning: Specified end_event (<end_event>) exceeds the maximum event number in file (<max_event_num>).
```

*(Warning is shown only if `end_event` is larger than the actual maximum event number in the file.)*

---

## 3. RAYRAW Data Format

- A valid event in the `.dat` file has the following structure:

1. Starts with **`0x45564E54`** (`EVNT`) → **Magic Number**
2. If **8 words (32-bit × 8)** later is **`0x45564E54`** (`EVNT`),  
   then this block is a **valid event header**
3. **Event number** is located **2 words after the magic number** (3rd word)
4. Event data is **variable-length** and continues until the next valid event header

Example:

```
[0]  0x45564E54  ← MAGIC
[1]  0x0000191e
[2]  0x00000005  ← Event Number
[3]  0x00000002
[4]  0x00000001
[5]  0x00000000
[6]  0x00000002
[7]  0x6653f5bf
[8]  0x45564E54  ← MAGIC (8 words after)
...
[Next Event] 0x45564E54 ...
```

- Events are **in ascending order**: `0, 1, 2, 3 ...`

---

## 4. Output Specification

- Only events in the range `[start_event, end_event]` are written
- Output file is automatically named:

```
run<run#>_<start_event>_<end_event>.dat
```

Example:

```bash
./extract_events /hoge/input/run00001.dat /hoge/output 10000 20000
# => /hoge/output/run00001_50000_60000.dat
```

If `end_event` exceeds the maximum event number in the file,  
the program **outputs all available events up to the end of the file** and prints a warning.

---

## 5. New Feature: Bookmark File Handling

- Each `.dat` input file has a **corresponding bookmark file**:

```
<input_directory>/bookmark/<basename>_bookmark.dat
```

Example:

```
Input:    /hoge/input/run00250.dat
Bookmark: /hoge/input/bookmark/run00250_bookmark.dat
```

- The program will automatically:

1. Check for the corresponding bookmark file
2. Ensure the **output bookmark directory** exists:

```
<output_directory>/bookmark/
```

3. Copy the bookmark file to this directory, renaming it as:

```
<output_directory>/bookmark/run00250_<start_event>_<end_event>_bookmark.dat
```

- If the input bookmark file does **not** exist, a warning is printed.

---

## 6. Important Notes

1. **Endianness**
   - RAYRAW `.dat` files are generated on Intel/AMD PCs → **Little Endian**
   - The program reads the file as little-endian 32-bit words

2. **Maximum Event Detection**
   - The program now **detects and prints the maximum event number in the input file**
   - If `end_event` is larger than the maximum, a **warning** is printed

3. **Bookmark Handling**
   - Bookmark file is automatically copied and renamed to match the extracted range
   - Output bookmark directory is created automatically if missing

4. **Large Files**
   - Supports very large `.dat` files (hundreds of thousands of events)
   - Streams the file word by word to avoid memory issues

5. **Early Exit for Speed**
   - Processing stops once the event number exceeds `end_event`
   - Significantly faster for partial extraction

---

## 7. License

This tool is free to use and modify for your experiments.

---

# auto_extract.sh

`auto_extract.sh` is a Bash script that **automates the extraction of events from RAYRAW `.dat` files**  
using the `extract_events` program. It continuously monitors a data directory, copies the latest file,  
and runs event extraction in sequential ranges of 10 events each.

---

## 1. Overview

- Monitors a **source directory** for new or updated `.dat` files generated by the DAQ system
- Every **1 minute**, the script:
  1. Detects the **latest `.dat` file**
  2. Copies it to a **working directory** with `copy` appended to its base name  
     Example: `run00001.dat` → `datacopy/run00001copy.dat`
  3. Runs the `extract_events` program on the copied file
  4. Extracts events **in sequential 10-event ranges**:
     ```
     0-9 → 10-19 → 20-29 → ...
     ```
  5. If the file does **not yet contain enough events** for the current range,  
     it **retries the same range** in the next iteration (to avoid missing late-arriving events)

- All actions and `extract_events` outputs are **logged to a daily log file**  
  in the directory specified by `LOG_DIR` using `tee -a` so they appear both on the console and in the log

---

## 2. Directory Configuration

At the top of `auto_extract.sh`, configure your directories as needed:

```bash
SRC_DIR="data"        # Source directory to monitor (DAQ output)
DST_DIR="datacopy"    # Directory to store temporary copied .dat files
OUT_DIR="output"      # Directory for event extraction results
LOG_DIR="logs"        # Directory for daily log files
```

**Replace these with appropriate absolute or relative paths** for your environment, e.g.:

```bash
SRC_DIR="/hoge/data"
DST_DIR="/hoge/datacopy"
OUT_DIR="/hoge/output"
LOG_DIR="/hoge/logs"
```

Make sure all directories exist and are writable.

---

## 3. Script Logic

Key variables in the script:

```bash
EXTRACT_CMD="./extract_events"  # Path to the compiled extraction program

start_event=0          # Starting event number
end_event=9            # Ending event number
```

Execution loop:

1. Check for the **latest `.dat` file** in `$SRC_DIR`
2. If found:
   - Copy to `$DST_DIR` with `copy` appended
   - Log the copy action with a timestamp
3. Run `extract_events` with the copied file and log the output
4. Parse `Max event number in file:` from the program output
5. Decide **whether to advance** to the next 10-event range or retry the current range
6. Sleep for 60 seconds and repeat

---

## 4. Logging

- Logs are saved to `${LOG_DIR}/YYYY-MM-DD.log`
- Each iteration is timestamped in the format `YYYY-MM-DD HH:MM:SS`
- `tee -a` is used so logs appear **both in the console and in the file**

Example log excerpt:

```
2025-08-02 15:00:00: Copied data/run00002.dat -> datacopy/run00002copy.dat
Output file: output/run00002_0_9.dat
Extraction complete.
Max event number in file: 10
2025-08-02 15:00:00: Max event (10) < end_event (9), retrying same range next loop.
```

---

## 5. Usage

1. Edit the `SRC_DIR`, `DST_DIR`, `OUT_DIR`, and `LOG_DIR` variables to match your environment
2. Ensure that:
   - `extract_events` is compiled and available in the same directory or adjust `EXTRACT_CMD`
   - All directories exist and are writable

3. Make the script executable:

```bash
chmod +x auto_extract.sh
```

4. Run the script:

```bash
./auto_extract.sh
```

5. To run it in the background:

```bash
nohup ./auto_extract.sh &
```

---

## 6. Behavior Summary

- **Incremental extraction**: 10 events per range
- **Retry logic**: If `max_event < end_event`, same range is retried
- **Automatic logging**: Daily log file with timestamps
- **Safe copy**: Operates on a copy of the latest `.dat` to avoid interfering with DAQ writes

---

## 7. Example Output

```
2025-08-02 15:00:00: Copied data/run00002.dat -> datacopy/run00002copy.dat
Output file: output/run00002_0_9.dat
Extraction complete.
Max event number in file: 10
2025-08-02 15:00:00: Max event (10) >= end_event (9), advancing to next range 10-19
```

---

## 8. License

This script is free to use and modify for your experiments.
